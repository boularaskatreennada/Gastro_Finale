{% include 'livreur/base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'styles/livreur/notificationsDel.css' %}">
{% endblock %}

{%  block content%}

<div class="flex-fill mb-3 d-flex flex-column main">
    <nav class="navbar navbar-expand px-3 py-1 bg-basic">
        <h3>Notifications</h3>

        <div class="navbar-collapse collapse">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item dropdown">
                <a href="" data-bs-toggle="dropdown" class="nav-icon pe-md-0">
                    <img src="{% static 'images/t√©l√©chargement.jpg' %}" class="avatar  img-fluid rounded-circle border border-dark" alt="">
                </a>
            
            </li>
          </ul>
        </div>
    </nav>
    
    

    <div class="list-group flex-fill" id="notifContainer">
      <!-- item 
      <div class="list-group-item d-flex align-items-start">
        <span class="badge bg-success me-3"><i class="bi bi-check-circle-fill"></i></span>
        <div class="flex-fill">
          <p class="mb-1"><strong>The Order 76943 is ready to be delivered!</strong></p>
          <small class="text-muted">Order #76943: 2 pizzas, 1 soda. Delivery address: 45 Street, Downtown</small>
          <div class="mt-2">
            <button class="btn btn-success btn-sm">Accept The Delivery</button>
          </div>
        </div>
      </div>
      

      <div class="list-group-item d-flex align-items-start">
        <span class="badge bg-danger me-3"><i class="bi bi-x-circle-fill"></i></span>
        <div class="flex-fill">
          <p class="mb-1"><strong>The Order 34754 Has Been Canceled</strong></p>
          <small class="text-muted">Order #34754 has been canceled. Do not pick up the order.</small>
        </div>
      </div>
      
      <div class="list-group-item d-flex align-items-start">
        <span class="badge bg-dark text-white me-3"><i class="bi bi-clock-fill"></i></span>
        <div class="flex-fill">
          <p class="mb-1"><strong>Delay Reported by Customer</strong></p>
          <small class="text-muted">The customer for order #1234 has reported a delay. Please contact them for more info.</small>
        </div>
      </div>
      
    




    </div>
  </div>
  <script>
    const socket = new WebSocket('ws://' + window.location.host + '/ws/delivery/');
    
    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const notificationHTML = `
            <div class="list-group-item d-flex align-items-start">
                <span class="badge bg-success me-3"><i class="bi bi-check-circle-fill"></i></span>
                <div class="flex-fill">
                    <p class="mb-1"><strong>Order #${data.order_id} Ready!</strong></p>
                    <small class="text-muted">
                        Client: ${data.client_name}<br>
                        Address: ${data.address}<br>
                        Total: $${data.total}<br>
                        Items: ${data.items.join(', ')}
                    </small>
                    <div class="mt-2">
                        <button onclick="acceptOrder(${data.order_id})" 
                                class="btn btn-success btn-sm">
                            Accept Delivery
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // Add new notification at the top
        const container = document.getElementById('notifContainer');
        container.insertAdjacentHTML('afterbegin', notificationHTML);
    };
    
    function acceptOrder(orderId) {
        socket.send(JSON.stringify({
            action: 'accept_order',
            order_id: orderId
        }));
        
        // Disable button after acceptance
        event.target.disabled = true;
        event.target.textContent = 'Accepted!';
    }
    </script> -->
    <script>
    // notificationsDel.html
const socket = new WebSocket('ws://' + window.location.host + '/ws/delivery/notifications/');

socket.onmessage = function(e) {
  console.log("üì© Raw WS message:", e.data); // <‚Äî add this
    const data = JSON.parse(e.data);
    
    
   
       
        const notificationHTML = `
            <div class="list-group-item">
                <p><strong>Order #${data.order_id || 'N/A'}</strong></p>
                <p>Client: ${data.client || 'Unknown'}</p>
                <p>Phone: ${data.phone || 'Not provided'}</p>
                <p>Items: ${(data.items && data.items.length) ? data.items.join(', ') : 'No items'}</p>
                <button type="button" class="btn btn-sm btn-success accept-btn" data-order-id="${data.order_id}"> Accept </button> 
            </div>
            
        `;
        document.getElementById('notifContainer').insertAdjacentHTML('afterbegin', notificationHTML);

   
};
document.getElementById('notifContainer').addEventListener('click', e => {
    if (!e.target.matches('.accept-btn')) return;
    const orderId = e.target.dataset.orderId;       // grabs data-order-id
    console.log('‚ñ∂Ô∏è About to send:', {action:'accept_order', order_id: orderId});
    socket.send(JSON.stringify({
      action: 'accept_order',
      order_id: orderId
    }));
    e.target.disabled = true;
    e.target.textContent = 'Accepted';
  });

    </script>
{% endblock %}