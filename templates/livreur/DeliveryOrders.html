{% include 'livreur/base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'styles/livreur/DeliveryOrders.css' %}">
{% endblock %}

{%  block content%}
<div class="flex-fill mb-3 d-flex flex-column main bg-basic">
    <nav class="navbar navbar-expand px-3 py-1 bg-basic">
        <h3>Delivery Orders</h3>

        <div class="navbar-collapse collapse">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item dropdown">
                <a href="" data-bs-toggle="dropdown" class="nav-icon pe-md-0">
                    <img src="{% static 'images/téléchargement.jpg' %}" class="avatar  img-fluid rounded-circle border border-dark" alt="">
                </a>
            
            </li>
          </ul>
        </div>
    </nav>
        
      
   

    <!-- Tabs for status filter -->
    <div class="container-fluid my-3">
        <div class="filter-bar">
          <ul class="nav nav-pills justify-content-between">
            <li class="nav-item flex-fill text-center">
              <a href="{% url 'DeliveryOrders' %}{% if request.GET.search %}?search={{ request.GET.search }}{% endif %}"
                class="nav-link filter-link {% if not filter_type %}active{% endif %}">
                All
              </a>
            </li>
           <li class="nav-item flex-fill text-center">
              <a href="{% url 'DeliveryOrders' %}?filter_type=pending{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}"
                class="nav-link filter-link {% if filter_type == 'pending' %}active{% endif %}">
                Pending
              </a>  
            </li>
            <li class="nav-item flex-fill text-center">
              <a href="{% url 'DeliveryOrders' %}?filter_type=in-progress{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}"
                class="nav-link filter-link {% if filter_type == 'in-progress' %}active{% endif %}">
                In Progress
              </a>
            </li>
            <li class="nav-item flex-fill text-center">
              <a href="{% url 'DeliveryOrders' %}?filter_type=delivered{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}"
                class="nav-link filter-link {% if filter_type == 'delivered' %}active{% endif %}">
                Delivered
              </a>
            </li>
            
          </ul>
        </div>
      </div>

     
    

    <!-- Cards container -->
    <div class="row g-4 flex-fill" id="cardsContainer">
      {% for delivery in delivery_orders %}
      <!-- example card; duplicate/adapt for each order -->
      <div class="col-12 col-md-3" data-status="Pending">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title text-danger"><i class="bi bi-box-seam-fill"></i> order# {{ delivery.order.pk }}</h5>
            <p class="mb-1"><i class="bi bi-person-fill"></i> {{ delivery.order.client.user.username}}</p>
            <p class="mb-1"><i class="bi bi-geo-alt-fill"></i> {{ delivery.address }}</p>
            <p class="mb-1"><i class="bi bi-telephone-fill"></i>  {{ delivery.order.client.user.phone }}</p>
            <p class="mb-1"> Total: <strong>{{ delivery.order.total_amount }} DA</strong></p>
            <p class="mb-1">Items: {{ delivery.order.orderdish_set.count }}</p>
            <div class="mb-3">
              <label class="form-label mb-0" for="Status"><i class="bi bi-clock-fill"></i> Status:</label>
              <form method="post" action="{% url 'update_delivery_status' delivery.pk %}">
                {% csrf_token %}
                <select id="Status" name="status" class="form-select form-select-sm d-inline-block w-auto" onchange="this.form.submit()">
                  {% for value, label in delivery_status_choices %}
                    <option value="{{ value }}"
                      {% if delivery.status == value %}selected{% endif %}>
                      {{ label }}
                    </option>
                  {% endfor %}
                </select>
              </form>
            </div>
            <button type="button"class="open-gm-btn btn btn-outline-primary direction"data-address="{{ delivery.address|escapejs }}"><i class="bi bi-geo-alt"></i> Get Directions</button>
          </div>
        </div>
      </div>
      {% empty %}
      <p>Aucune livraison trouvée.</p>
      {% endfor %}
    </div>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const buttons = document.querySelectorAll('.direction');

  buttons.forEach(btn => {
    btn.addEventListener('click', () => {
      const dest = encodeURIComponent(btn.dataset.address);
      const url = `https://www.google.com/maps/dir/?api=1` +
                  `&destination=${dest}` +
                  `&travelmode=driving`;
      window.open(url, '_blank');
    });
  });
});
</script>
{% endblock %}
